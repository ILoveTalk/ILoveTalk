<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generation Studio</title>
    <style>
        /* --- Universal Styles --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #0d1117;
            --surface-color: #161b22;
            --primary-color: #58a6ff;
            --primary-hover: #79c0ff;
            --text-color: #e6edf3;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --shadow-light: rgba(88, 166, 255, 0.2);
            --danger-color: #f85149;
            --danger-hover: #da3633;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 2rem;
            min-height: 100vh;
        }
        
        body.lightbox-open { overflow: hidden; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Main Layout --- */
        .container {
            display: flex;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            gap: 2rem;
        }

        .controls-panel {
            width: 400px;
            flex-shrink: 0;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-self: flex-start;
            position: sticky;
            top: 2rem;
        }

        .header h1 {
            font-size: 1.8rem; margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { font-size: 0.9rem; color: var(--text-muted); }

        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        label { font-weight: 600; font-size: 0.9rem; }
        
        textarea, select, input {
            width: 100%; background-color: var(--bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 8px;
            padding: 0.75rem; font-family: 'Inter', sans-serif; font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus, select:focus, input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-light);
        }
        textarea { resize: vertical; min-height: 100px; }

        .generate-button {
            width: 100%; padding: 1rem; background: var(--primary-color);
            color: #0d1117; border: none; border-radius: 8px;
            font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .generate-button:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
        .generate-button .spinner {
            width: 20px; height: 20px; border: 3px solid rgba(13, 17, 23, 0.3);
            border-top-color: var(--bg-color); border-radius: 50%; animation: spin 0.8s linear infinite;
        }

        .image-panel { flex-grow: 1; display: flex; flex-direction: column; gap: 2rem; }

        .generation-batch {
            animation: fadeIn 0.5s ease; background: var(--surface-color);
            padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);
        }
        .batch-header { margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .batch-header h3 { font-size: 1.1rem; overflow-wrap: break-word; }
        .batch-header p { color: var(--text-muted); font-size: 0.8rem; }
        
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; width: 100%; }
        
        .masonry-grid { column-count: 4; column-gap: 1rem; }
        
        .image-item, .history-item {
            position: relative; border-radius: 8px; overflow: hidden;
            background-color: var(--bg-color); cursor: pointer; animation: fadeIn 0.5s ease-out;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block; width: 100%; margin-bottom: 1rem; break-inside: avoid;
        }
        .image-item:hover, .history-item:hover { transform: scale(1.02); box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 5; }
        .image-item img, .history-item img { width: 100%; height: auto; display: block; }
        
        .history-item.selected { box-shadow: 0 0 0 3px var(--primary-color), 0 8px 30px rgba(0,0,0,0.4); }

        .image-placeholder {
            width: 100%;
            border-radius: 8px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .item-checkbox {
            position: absolute; top: 8px; left: 8px; width: 24px; height: 24px;
            background: rgba(0,0,0,0.7); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s, background-color 0.2s;
            z-index: 10;
        }
        .history-item:hover .item-checkbox, .history-item.selected .item-checkbox { opacity: 1; }
        .history-item.selected .item-checkbox { background-color: var(--primary-color); }
        .item-checkbox svg { display: none; }
        .history-item.selected .item-checkbox svg { display: block; }

        .item-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7); color: white; border: none;
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease-out;
            opacity: 0;
            transform: translateY(-5px);
            z-index: 10;
        }
        .image-item:hover .item-btn, .history-item:hover .item-btn {
            opacity: 1;
            transform: translateY(0);
        }
        .item-btn:hover { background: var(--primary-color); }

        #gallery h2 { margin-bottom: 1rem; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .history-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .history-controls > * { flex: 1 1 auto; min-width: 120px; }
        .history-controls input, .history-controls select, .history-controls button {
            padding: 0.5rem 1rem; background-color: var(--surface-color);
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 6px; cursor: pointer; height: 38px;
        }
        #deleteSelectedBtn { background-color: var(--danger-color); color: white; border: none; }
        #deleteSelectedBtn:hover:not(:disabled) { background-color: var(--danger-hover); }
        #deleteSelectedBtn:disabled { background-color: var(--border-color); cursor: not-allowed; opacity: 0.6; }
        #selectAllBtn { background-color: var(--primary-color); color: #0d1117; border: none; }
        #selectAllBtn:hover:not(:disabled) { background-color: var(--primary-hover); }
        #downloadJsonBtn { background-color: var(--primary-color); color: #0d1117; border: none; }
        #downloadJsonBtn:hover:not(:disabled) { background-color: var(--primary-hover); }
        #downloadJsonBtn:disabled { background-color: var(--border-color); cursor: not-allowed; opacity: 0.6; }

        .empty-state-message { width: 100%; text-align: center; color: var(--text-muted); padding: 3rem 1rem; border: 2px dashed var(--border-color); border-radius: 12px; }

        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #lightbox.visible { opacity: 1; pointer-events: all; }
        .lightbox-content { display: flex; gap: 2rem; max-width: 90vw; max-height: 90vh; animation: fadeIn 0.3s ease forwards; }
        .lightbox-image-container { flex-shrink: 1; min-width: 0; display: flex; align-items: center; justify-content: center; }
        .lightbox-image-container img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        .lightbox-details { width: 350px; flex-shrink: 0; background: var(--surface-color); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; }
        .lightbox-details h3 { font-size: 1.2rem; }
        .detail-item { font-size: 0.9rem; color: var(--text-muted); word-wrap: break-word; }
        .detail-item strong { color: var(--text-color); display: block; margin-bottom: 0.25rem; }
        #lightbox-close, #lightbox-reuse-btn { padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        #lightbox-reuse-btn { background: var(--primary-color); color: #0d1117; }
        #lightbox-reuse-btn:hover { background: var(--primary-hover); }
        #lightbox-close { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; width: 40px; height: 40px; border-radius: 50%; }

        @media (max-width: 1200px) { .masonry-grid { column-count: 3; } }
        @media (max-width: 900px) {
            body { padding: 1rem; } .container { flex-direction: column; } .controls-panel { width: 100%; position: static; }
            .masonry-grid { column-count: 2; } .lightbox-content { flex-direction: column; max-width: 95vw; max-height: 95vh; }
            .lightbox-details { width: 100%; max-height: 250px; }
        }
        @media (max-width: 500px) { .masonry-grid { column-count: 1; } }
    </style>
  <script type='text/javascript' src='//pl27536513.revenuecpmgate.com/0e/ba/e1/0ebae14a2c4fd17023b876ff5b6e280b.js'></script>
</head>
<body>

    <div class="container">
        <!-- CONTROLS PANEL (Left) -->
        <div class="controls-panel">
            <div class="form-group"><label for="prompt_box">Enter Your Prompt</label><textarea id="prompt_box" placeholder="e.g., A cinematic shot of a cat astronaut on Mars, detailed, 8k"></textarea></div>
            <button class="generate-button" id="generateBtn">Generate Images</button>
            <div class="form-group" style="display:none">
                <label for="vibe">Vibe / Style</label>
                <select id="vibe">
                    <option value="professional-photo">Professional Photo</option>
                    <option value="concept-art">Concept Art</option>
                    <option value="3d-render">3D Render</option>
                    <option value="anime">Anime / Toon Art</option>
                    <option value="pixel-art">Pixel Art</option>
                    <option value="random-photo">Random/Amateur Photo</option>
                </select>
            </div>
            <div class="form-group" style="display:none"><label for="resSelect">Resolution</label><select id="resSelect"><option value="768x512">768x512 (Landscape)</option><option value="512x768">512x768 (Portrait)</option><option value="768x768">768x768 (Square)</option><option value="512x512">512x512 (Square)</option></select></div>
            <div class="form-group"><label for="custom_negative">Custom Negative Prompt</label><textarea id="custom_negative" placeholder="e.g., extra fingers, blurry" style="min-height: 60px;"></textarea></div>
        </div>

        <!-- IMAGE PANEL (Right) -->
        <div class="image-panel">
            <div id="generationContainer"></div>
            <div id="gallery" style="display:none">
                <h2>History</h2>
                <div class="history-controls">
                    <input type="text" id="historySearch" placeholder="ðŸ”Ž Search by prompt...">
                    <select id="historyFilterResolution"><option value="all">All Resolutions</option><option value="768x512">768x512</option><option value="512x768">512x768</option><option value="768x768">768x768</option><option value="512x512">512x512</option></select>
                    <select id="historyFilterStyle">
                        <option value="all">All Styles</option>
                        <option value="professional-photo">Professional Photo</option>
                        <option value="concept-art">Concept Art</option>
                        <option value="3d-render">3D Render</option>
                        <option value="anime">Anime / Toon Art</option>
                        <option value="pixel-art">Pixel Art</option>
                        <option value="emotional">Emotional</option>
                        <option value="sad">Sad</option>
                        <option value="funny">Funny</option>
                        <option value="comedy">Comedy</option>
                        <option value="hook">Hook</option>
                        <option value="backrooms">Backrooms (Eerie)</option>
                        <option value="random-photo">Random/Amateur Photo</option>
                        <option value="advertising">Advertisement</option>
                        <option value="app-ui">App UI/UX</option>
                        <option value="website-ui">Website UI/UX</option>
                        <option value="shitty-drawing">Bad Drawing (Funny)</option>
                    </select>
                    <button id="selectAllBtn">Select All</button>
                    <button id="deleteSelectedBtn" disabled>Delete Selected</button>
                    <button id="downloadJsonBtn" disabled>Download JSON</button>
                </div>
                <div id="historyImages" class="masonry-grid"></div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX (FULLSCREEN VIEWER) -->
    <div id="lightbox">
        <button id="lightbox-close">&times;</button>
        <div class="lightbox-content">
            <div class="lightbox-image-container"><img id="lightbox-img" src="" alt="Full-screen image"></div>
            <div class="lightbox-details">
                <h3>Details</h3>
                <div class="detail-item"><strong>Prompt</strong><p id="lightbox-prompt"></p></div>
                <div class="detail-item"><strong>Seed</strong><p id="lightbox-seed"></p></div>
                <div class="detail-item"><strong>Resolution</strong><p id="lightbox-res"></p></div>
                <div class="detail-item"><strong>Date</strong><p id="lightbox-date"></p></div>
                <button id="lightbox-reuse-btn">Reuse Settings</button>
            </div>
        </div>
    </div>

    <script>
        // --- START OF NEW IndexedDB DATABASE LOGIC ---
        const DB_NAME = 'AI_Image_History';
        const DB_VERSION = 1;
        const STORE_NAME = 'images';
        let db;

        function openDb() {
            return new Promise((resolve, reject) => {
                if (db) {
                    return resolve(db);
                }
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => reject('Database error: ' + event.target.errorCode);
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveImageToDb(imageData) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(imageData);
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject('Transaction error: ' + event.target.error);
            });
        }
        
        async function getImagesFromDb() {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result.reverse()); // Show newest first
                request.onerror = (event) => reject('Request error: ' + event.target.error);
            });
        }
        
        async function deleteImagesFromDb(ids) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                ids.forEach(id => store.delete(id));
                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => reject('Delete transaction error: ' + event.target.error);
            });
        }
        
        // Utility to convert dataURL to a Blob for efficient storage
        function dataURLToBlob(dataURL) {
            const byteString = atob(dataURL.split(',')[1]);
            const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        }
        // --- END OF NEW IndexedDB DATABASE LOGIC ---

        // This is no longer loaded from localStorage. It will be loaded from IndexedDB.
        let imageHistory = [];
        
        const dom = {
            controls: { promptBox: document.getElementById('prompt_box'), vibeSelect: document.getElementById('vibe'), quantityInput: document.getElementById('quantity'), resSelect: document.getElementById('resSelect'), generateBtn: document.getElementById('generateBtn') },
            main: {
                generationContainer: document.getElementById('generationContainer'), galleryContainer: document.getElementById('historyImages'), deleteBtn: document.getElementById('deleteSelectedBtn'),
                historySearch: document.getElementById('historySearch'), historyResFilter: document.getElementById('historyFilterResolution'), historyStyleFilter: document.getElementById('historyFilterStyle'),
                selectAllBtn: document.getElementById('selectAllBtn'), downloadJsonBtn: document.getElementById('downloadJsonBtn')
            },
            lightbox: { element: document.getElementById('lightbox'), img: document.getElementById('lightbox-img'), prompt: document.getElementById('lightbox-prompt'), seed: document.getElementById('lightbox-seed'), res: document.getElementById('lightbox-res'), date: document.getElementById('lightbox-date'), reuseBtn: document.getElementById('lightbox-reuse-btn'), closeBtn: document.getElementById('lightbox-close') }
        };

        let activeJobs = 0;
        let selectedHistoryIds = new Set();
        let currentLightboxData = null;

        // The saveHistory function is no longer needed.
        const generateSeed = () => Math.floor(Math.random() * 1000000);
        const formatDate = (ts) => new Date(ts).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });

        function createImageItem(imageData, isHistory = false) {
            const item = document.createElement('div');
            item.className = isHistory ? 'history-item' : 'image-item';
            
            const img = document.createElement('img');
            // Check if data is a Blob and create an object URL for it
            if (imageData.blob instanceof Blob) {
                img.src = URL.createObjectURL(imageData.blob);
                // Revoke the URL when the image is no longer needed (improves performance)
                img.onload = () => URL.revokeObjectURL(img.src);
            } else {
                 img.src = imageData.dataUrl; // Fallback for any old data format
            }
            
            img.alt = imageData.prompt; 
            img.loading = 'lazy';
            
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'item-btn'; 
            downloadBtn.title = 'Download Image';
            downloadBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
            downloadBtn.onclick = (e) => { e.stopPropagation(); downloadImage(imageData, `ai-${imageData.seed}.png`); };
            
            item.append(img, downloadBtn);

            if (isHistory) {
                item.dataset.id = imageData.id; 
                if (selectedHistoryIds.has(imageData.id)) item.classList.add('selected');

                const checkbox = document.createElement('div');
                checkbox.className = 'item-checkbox';
                checkbox.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                checkbox.onclick = (e) => { e.stopPropagation(); toggleHistorySelection(item, imageData.id); };
                
                item.appendChild(checkbox);
                item.onclick = (e) => { if (e.target.closest('.item-checkbox')) return; openLightbox(imageData); };
            } else {
                 item.onclick = () => openLightbox(imageData);
            }
            return item;
        }

        function openLightbox(imageData) {
            currentLightboxData = imageData;
            const { prompt, seed, resolution, timestamp } = imageData;
            if (imageData.blob instanceof Blob) {
                 dom.lightbox.img.src = URL.createObjectURL(imageData.blob);
                 dom.lightbox.img.onload = () => URL.revokeObjectURL(dom.lightbox.img.src);
            } else {
                dom.lightbox.img.src = imageData.dataUrl;
            }
            dom.lightbox.prompt.textContent = prompt; dom.lightbox.seed.textContent = seed;
            dom.lightbox.res.textContent = resolution; dom.lightbox.date.textContent = formatDate(timestamp);
            dom.lightbox.element.classList.add('visible'); document.body.classList.add('lightbox-open');
        }

        function closeLightbox() {
            dom.lightbox.element.classList.remove('visible'); document.body.classList.remove('lightbox-open'); currentLightboxData = null;
        }
        
        async function downloadImage(imageData, filename) {
             const blob = imageData.blob;
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = filename;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(url);
        }

        async function handleGenerate() {
            let prompt = dom.controls.promptBox.value.trim();
            if (!prompt) { alert("Please enter a prompt to generate an image."); return; }

window.open('https://www.revenuecpmgate.com/ibhwtzuijy?key=d500165318a9a5dd51c216787ebc210a', '_blank');
            
            const quantity = 1, resolution = dom.controls.resSelect.value, style = dom.controls.vibeSelect.options[dom.controls.vibeSelect.selectedIndex].text, fullPrompt = `${style}: ${prompt}`;
            
            activeJobs++; updateGenerateButton();

            const batchContainer = document.createElement('div'); batchContainer.className = 'generation-batch';
            batchContainer.innerHTML = `<div class="batch-header"><h3>${fullPrompt}</h3><p>${quantity} images @ ${resolution}</p></div><div class="image-grid"></div>`;
            dom.main.generationContainer.prepend(batchContainer);
            
            const imageGrid = batchContainer.querySelector('.image-grid');
            const placeholders = [];

            const [width, height] = resolution.split('x').map(Number);
            const aspectRatio = `${width} / ${height}`;

            for (let i = 0; i < quantity; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.style.aspectRatio = aspectRatio;
                const loader = document.createElement('div');
                loader.className = 'loader';
                placeholder.appendChild(loader);
                imageGrid.appendChild(placeholder);
                placeholders.push(placeholder);
            }
            
            const generationPromises = placeholders.map((placeholder, index) => {
                const seed = generateSeed();
                return generateImage(fullPrompt, { 
                        seed: seed, 
                        resolution: resolution,
                        guidance: 8 
                    })
                    .then(async (dataUrl) => { // Made this async to await the DB save
                        const imageBlob = dataURLToBlob(dataUrl);
                        const imageData = { 
                            id: Date.now() + Math.random(), // Unique ID
                            blob: imageBlob, 
                            prompt: fullPrompt, 
                            seed, 
                            resolution, 
                            style: dom.controls.vibeSelect.value, 
                            timestamp: new Date().toISOString() 
                        };

                        await saveImageToDb(imageData); // Save to IndexedDB

                        imageHistory.unshift(imageData); // Update in-memory array for immediate display
                        
                        const finalImageItem = createImageItem(imageData);
                        requestAnimationFrame(() => {
                           placeholder.replaceWith(finalImageItem);
                           renderHistory(); // Refresh history list
                        });
                    }).catch(err => {
                        console.error("Image generation failed for a request:", err);
                        placeholder.innerHTML = 'âš ï¸';
                        placeholder.style.fontSize = '2rem';
                        placeholder.style.backgroundColor = '#4d1c1c';
                    });
            });

            await Promise.allSettled(generationPromises);
            activeJobs--; updateGenerateButton();
        }

        function updateGenerateButton() { dom.controls.generateBtn.innerHTML = activeJobs > 0 ? `<div class="spinner"></div> Generating...` : 'Generate Images'; }
        
        function renderHistory() {
            dom.main.galleryContainer.innerHTML = '';
            const searchTerm = dom.main.historySearch.value.toLowerCase(), resFilter = dom.main.historyResFilter.value, styleFilter = dom.main.historyStyleFilter.value;
            const filtered = imageHistory.filter(item => (item.prompt.toLowerCase().includes(searchTerm)) && (resFilter === 'all' || item.resolution === resFilter) && (styleFilter === 'all' || item.style === styleFilter));

            if (filtered.length === 0) {
                dom.main.galleryContainer.innerHTML = '<div class="empty-state-message"><h3>No History Found</h3><p>Try adjusting your search filters or generate new images.</p></div>';
                return;
            }
            filtered.forEach(item => { dom.main.galleryContainer.appendChild(createImageItem(item, true)); });
        }
        
        function toggleHistorySelection(element, id) {
            const numericId = parseFloat(element.dataset.id);
            element.classList.toggle('selected');
            if (selectedHistoryIds.has(numericId)) selectedHistoryIds.delete(numericId); else selectedHistoryIds.add(numericId);
            updateDeleteButtonState();
        }
        
        function updateDeleteButtonState() {
            const hasSelection = selectedHistoryIds.size > 0;
            dom.main.deleteBtn.disabled = !hasSelection;
            dom.main.deleteBtn.textContent = hasSelection ? `Delete Selected (${selectedHistoryIds.size})` : 'Delete Selected';
            dom.main.downloadJsonBtn.disabled = !hasSelection;
            dom.main.downloadJsonBtn.textContent = hasSelection ? `Download JSON (${selectedHistoryIds.size})` : 'Download JSON';
        }
        
        async function deleteSelectedHistory() {
            if (selectedHistoryIds.size === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedHistoryIds.size} images? This cannot be undone.`)) {
                const idsToDelete = Array.from(selectedHistoryIds);
                await deleteImagesFromDb(idsToDelete); // Delete from DB
                imageHistory = imageHistory.filter(item => !idsToDelete.includes(item.id)); // Update in-memory array
                selectedHistoryIds.clear();
                renderHistory(); // Re-render the UI
                updateDeleteButtonState();
            }
        }

        function selectAllVisibleImages() {
            const searchTerm = dom.main.historySearch.value.toLowerCase();
            const resFilter = dom.main.historyResFilter.value;
            const styleFilter = dom.main.historyStyleFilter.value;
            const filtered = imageHistory.filter(item => 
                (item.prompt.toLowerCase().includes(searchTerm)) && 
                (resFilter === 'all' || item.resolution === resFilter) && 
                (styleFilter === 'all' || item.style === styleFilter)
            );

            // Add all filtered image IDs to selection
            filtered.forEach(item => selectedHistoryIds.add(item.id));
            
            // Re-render history to show selection
            renderHistory();
            updateDeleteButtonState();
        }

        function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        async function downloadSelectedAsJson() {
            if (selectedHistoryIds.size === 0) return;

            // Get selected image data
            const selectedImages = imageHistory.filter(item => selectedHistoryIds.has(item.id));
            
            // Convert blobs to data URLs for JSON serialization
            const imagesForJson = await Promise.all(selectedImages.map(async (item) => {
                const dataUrl = await blobToDataURL(item.blob);
                return {
                    id: item.id,
                    dataUrl: dataUrl,
                    prompt: item.prompt,
                    seed: item.seed,
                    resolution: item.resolution,
                    style: item.style,
                    timestamp: item.timestamp
                };
            }));

            // Create JSON file
            const jsonString = JSON.stringify(imagesForJson, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-images-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- Event Listeners ---
        dom.controls.generateBtn.onclick = handleGenerate;
        dom.lightbox.closeBtn.onclick = closeLightbox;
        dom.lightbox.element.onclick = (e) => { if (e.target === dom.lightbox.element) closeLightbox(); };
        window.onkeydown = (e) => { if (e.key === 'Escape') closeLightbox(); };
        dom.lightbox.reuseBtn.onclick = () => {
            if (!currentLightboxData) return;
            const { prompt, resolution, style } = currentLightboxData;
            const styleTextElement = Array.from(dom.controls.vibeSelect.options).find(o => o.value === style);
            if(styleTextElement) { const styleText = styleTextElement.text; dom.controls.promptBox.value = prompt.replace(`${styleText}: `, ''); } 
            else { dom.controls.promptBox.value = prompt; }
            dom.controls.resSelect.value = resolution;
            dom.controls.vibeSelect.value = style;
            closeLightbox();
        };
        dom.main.deleteBtn.onclick = deleteSelectedHistory;
        dom.main.selectAllBtn.onclick = selectAllVisibleImages;
        dom.main.downloadJsonBtn.onclick = downloadSelectedAsJson;
        dom.main.historySearch.oninput = renderHistory;
        dom.main.historyResFilter.onchange = renderHistory;
        dom.main.historyStyleFilter.onchange = renderHistory;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                imageHistory = await getImagesFromDb(); // Load from IndexedDB on startup
                renderHistory();
            } catch (error) {
                console.error("Could not load history from the database:", error);
                alert("Error: Could not load image history.");
            }
            updateDeleteButtonState();
        });
    </script>
  <script async="async" data-cfasync="false" src="//pl27488196.revenuecpmgate.com/b31976d08e424f1df16c600bd9425c89/invoke.js"></script>
<div id="container-b31976d08e424f1df16c600bd9425c89"></div>
</body>

</html>
